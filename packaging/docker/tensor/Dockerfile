FROM ubuntu:16.04

# Add tensor debian generated by the
# TODO: move to a ppa
ADD tensor.deb /tmp/tensor.deb
# add our user and group first to make sure their IDs get assigned consistently, regardless of whatever dependencies get added
RUN groupadd -r tensor && useradd -r -g tensor tensor

# gcc for cgo and ansible dependencies
RUN export DEBIAN_FRONTEND=noninteractive && \
    apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 6125E2A8C77F2818FB7BD15B93C4A3FD7BB9C367 && \
    echo "deb http://ppa.launchpad.net/ansible/ansible/ubuntu xenial main" | tee /etc/apt/sources.list.d/ansible.list && \
    apt-get -q update && \
    apt-get -y -q install \
    ansible \
    git \
    subversion \
    mercurial \
    python-dev \
    libkrb5-dev \
    python-pip \
    krb5-user && \
    # install python packages
    pip install -U \
    pip \
    wheel \
    setuptools && \
    pip install --upgrade \
    "pywinrm>=0.1.1" \
    kerberos \
    requests_kerberos && \
    apt-get -y install /tmp/tensor.deb && \
    # clean up
    apt-get --purge remove -y -q --auto-remove build-essential python-pip && \
    apt-get clean && rm -rf /var/lib/apt/lists/* && rm -rf /tmp/* && \
    # create project home directory and remove tensor configuration
    mkdir -p "/data" && \
    echo 'localhost' > /etc/ansible/hosts && \
    rm /etc/tensor.conf && rm /etc/krb5.conf

ENV TENSOR_PORT=8010 PROJECTS_HOME="/data" \
    TENSOR_DB_USER=tensor TENSOR_DB_PASSWORD=tensor TENSOR_DB_NAME=tensordb \
    TENSOR_DB_REPLICA="" TENSOR_DB_HOSTS="mongo:27017" KRB5_CONFIG="/data/krb5.conf" \
    ANSIBLE_CONFIG="/etc/ansible/ansible.cfg" TENSOR_REDIS_HOST="redis:6379"

VOLUME /data

WORKDIR /data

CMD ["tensord"]
